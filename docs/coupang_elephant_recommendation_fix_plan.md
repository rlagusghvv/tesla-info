# 쿠팡 코끼리 — 추천(Recommendation) 오류/개선 포인트 중심 작업 계획

> 작성: 2026-02-12
> 원칙: **기존 업로드(링크로 업로드) 로직은 이미 안정적으로 동작**하므로 최대한 수정하지 않는다.
> 작업 범위는 **추천 영역(상품 추천/검증/근거/리스크)** 중심으로 최소 침습적으로 개선한다.

---

## 1) 문제 정의(대표 피드백 반영)
- 업로드(링크 업로드) 자체는 잘 돌아가나, **추천 화면에서 여러 상품을 “한 번에 업로드(배치 업로드)”** 할 때 오류가 발생
- 목표는 사용자가 직접 깊게 디깅하지 않아도 경쟁력 있는 상품을 빠르게 올릴 수 있게,
  - 후보를 모아주고
  - 우선순위를 매기고
  - 근거를 보여주고
  - 리스크를 줄이는 것

### 대표가 마지막으로 확인한 재현 조건
- 추천 결과에서 **복수 상품 선택 → 한 번에 업로드** 시 터짐(배치 처리 문제)

---

## 2) 추천 시스템 MVP(오늘 ‘돌아가게’)

### 입력
- 사용자가 제공하는 최소 정보:
  - 키워드(필수)
  - 카테고리/가격대(선택)
  - (가능하면) 목표 마진/배송 타입/재고 형태 등

### 출력(추천 카드 5~20개)
각 추천 아이템에 대해:
- 제목/키워드
- 예상 포지셔닝(가격대, 경쟁 수준)
- 추천 액션(상세페이지/옵션/이미지/광고 키워드)
- 근거(사용한 데이터 출처/기간/정의)
- 리스크(리뷰 진입장벽/규정/계절성)

### 오늘의 스코프
- 실제 데이터 연동이 아직 없더라도,
  - UI/플로우는 실사용 수준으로 제공
  - 추천 결과는 **deterministic mock + 입력 기반 규칙**으로 먼저 제공
  - 이후 데이터 소스 교체 가능하도록 인터페이스 분리

---

## 3) 오류 원인 분류(추천 파트)
추천 오류는 보통 아래 중 하나:
1) 입력 검증 미흡(빈 값/형식 오류)
2) 추천 API 응답 스키마 불일치(프론트/백 싱크)
3) 외부 의존(크롤러/API) 실패 시 fallback 부재
4) 근거 계산에서 예외(0 division, null handling)
5) 추천 결과가 너무 느림(타임아웃) → 사용자 경험상 ‘오류’

## 3-1) 배치 업로드(추천→복수 업로드)에서 터지는 전형 패턴
- **서버 단일 요청 바디가 커짐**(많은 상품) → 제한/타임아웃/413
- **동시성 문제**: 한 번에 N개 업로드를 병렬로 때리며 rate limit/DB lock/세션 충돌
- **부분 실패 처리 부재**: 1개 실패하면 전체가 fail로 끝나 사용자에겐 “전부 실패”로 보임
- **중복 업로드**: 재시도 시 동일 상품이 여러 번 업로드(멱등성 부족)
- **프론트 상태 꼬임**: 진행률/성공/실패를 상품별로 분리 표시하지 않아 UI가 멈춘 듯 보임

---

## 4) 최소 침습 수정 전략
- 업로드로 넘어가는 경로는 유지(기존 업로드 코드 최대한 건드리지 않음)
- 추천/배치 업로드를 **얇은 오케스트레이션 레이어**로 분리
  - 추천: `/api/recommend`
  - 배치 업로드: `/api/upload/batch` (또는 기존 엔드포인트에 `batch` 액션 추가)

### 배치 업로드 핵심(반드시)
- 서버는 요청을 받으면:
  1) payload 검증(상품 수/필수 필드)
  2) **job 생성(jobId)**
  3) 상품별로 업로드를 순차 또는 제한 병렬(예: concurrency=2~3)
  4) 결과를 상품 단위로 기록(성공/실패 사유)
- 클라이언트는:
  - jobId 기준으로 진행률을 폴링/스트리밍
  - 상품별 성공/실패를 리스트로 보여줌(전체 실패처럼 보이지 않게)

### 멱등성(idempotency)
- `idempotencyKey = userId + productCandidateId + (day)` 같은 키를 두고
  - 재시도 시 중복 업로드 방지

### 실패 시 fallback(추천 영역)
- (A) 마지막 성공 추천 결과 캐시 반환
- (B) 규칙 기반 기본 추천 반환
- (C) 사용자에게 “왜 실패했는지”를 짧게 표시

---

## 5) ‘유료급 품질’로 가기 위한 추천 디테일
- 추천 결과에 **근거/정의**를 항상 붙인다(신뢰)
- 추천 액션은 “오늘 할 일”로 변환한다(실행)
- 추천 우선순위는 3개의 축으로 단순화:
  - 수요(traffic)
  - 경쟁(competition)
  - 실행가능성(effort)

---

## 6) 다음 액션(필수 정보)
추천 오류를 빠르게 잡으려면 아래 3개가 필요:
1) 현재 추천 endpoint/코드 위치(파일/URL)
2) 실제 에러 로그 1~2개(대표가 말한 ‘오류’ 재현 시 콘솔/서버 로그)
3) 추천 → 업로드로 이어지는 화면/버튼/플로우 정의(어느 지점에서 끊기는지)

---

## 7) 이미 준비된(임시) 추천 플로우
- `coupang-elephant/` Next.js 프로젝트에 `키워드 입력 → 분석 결과/액션` MVP 라우트가 있음.
- 이는 추천 시스템의 UI/플로우 템플릿으로 사용 가능하며,
  실제 추천/업로드 코드가 있는 메인 제품에 이 구조를 이식하는 것을 권장.

